<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iTabs for GoFundMe - Make Your Campaign Stand Out | itabs.ai</title>

    <!-- SEO & Social -->
    <meta name="description" content="Turn your GoFundMe campaign into a visual story people actually read. AI-powered tool organizes your story into clear sections that build trust and drive donations.">
    <meta property="og:title" content="iTabs for GoFundMe - Make Your Campaign Stand Out">
    <meta property="og:description" content="Turn your fundraiser into a visual story people actually read. Free tool.">
    <meta property="og:url" content="https://itabs.ai/gofundme">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíö</text></svg>">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* GoFundMe Brand Colors */
            --gfm-green: #00b964;
            --gfm-green-dark: #00a857;
            --gfm-green-light: #e6f9f0;
            --gfm-heart: #fb7c59;
            
            /* Neutrals */
            --text-dark: #1a1a2e;
            --text-mid: #4a5568;
            --text-light: #718096;
            --bg-white: #ffffff;
            --bg-grey: #f7f8fa;
            --border-light: #e2e8f0;
            
            /* Status */
            --success: #10b981;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, var(--gfm-green-light) 0%, var(--bg-grey) 25%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        /* ========== LAYOUT ========== */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        @media (min-width: 1024px) {
            .app-container {
                display: grid;
                grid-template-columns: 1fr 420px;
                gap: 30px;
                padding: 30px;
            }
        }

        /* ========== HEADER ========== */
        .header {
            text-align: center;
            margin-bottom: 25px;
            grid-column: 1 / -1;
        }

        .header h1 {
            font-size: 2em;
            font-weight: 700;
            color: var(--gfm-green);
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-mid);
            font-size: 1.05em;
        }

        .header .badge {
            display: inline-block;
            background: var(--gfm-green);
            color: white;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 12px;
        }

        /* ========== PANELS ========== */
        .form-panel {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .preview-panel {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        @media (max-width: 1023px) {
            .preview-panel {
                margin-top: 25px;
                position: static;
            }
        }

        /* ========== WHY SECTION ========== */
        .why-section {
            background: linear-gradient(135deg, #fff5f2 0%, #fff8f5 100%);
            border: 1px solid rgba(251, 124, 89, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .why-section h3 {
            color: var(--gfm-heart);
            font-size: 1.1em;
            margin-bottom: 12px;
        }

        .why-section p {
            color: var(--text-mid);
            font-size: 0.92em;
            line-height: 1.7;
        }

        .why-section strong {
            color: var(--text-dark);
        }

        /* ========== FORM SECTIONS ========== */
        .form-section {
            margin-bottom: 24px;
            padding: 22px;
            background: var(--bg-grey);
            border-radius: 14px;
            border: 1px solid var(--border-light);
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--gfm-green);
            border-radius: 2px;
        }

        label {
            display: block;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 6px;
        }

        input[type="text"],
        input[type="url"],
        textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border-light);
            border-radius: 10px;
            font-size: 0.95em;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: var(--bg-white);
            margin-bottom: 16px;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--gfm-green);
            box-shadow: 0 0 0 3px rgba(0, 185, 100, 0.1);
        }

        textarea {
            min-height: 85px;
            resize: vertical;
        }

        .helper-text {
            font-size: 0.82em;
            color: var(--text-light);
            margin-top: -12px;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        /* ========== INFO BOX ========== */
        .info-box {
            background: linear-gradient(135deg, var(--gfm-green-light) 0%, #f0fff8 100%);
            border-left: 4px solid var(--gfm-green);
            padding: 14px 16px;
            border-radius: 0 10px 10px 0;
            margin-bottom: 18px;
            font-size: 0.9em;
            color: var(--text-mid);
            line-height: 1.6;
        }

        .info-box strong {
            color: var(--gfm-green-dark);
        }

        .info-box a {
            color: var(--gfm-green);
            font-weight: 600;
        }

        /* ========== TEMPLATE BUTTONS ========== */
        .template-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .template-btn {
            padding: 12px;
            border: 2px solid var(--border-light);
            background: var(--bg-white);
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: var(--text-mid);
        }

        .template-btn:hover {
            border-color: var(--gfm-green);
            background: var(--gfm-green-light);
            color: var(--gfm-green);
        }

        .template-btn.active {
            border-color: var(--gfm-green);
            background: var(--gfm-green);
            color: white;
        }

        /* ========== BUTTONS ========== */
        .btn {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gfm-green) 0%, var(--gfm-green-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 185, 100, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 185, 100, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-white);
            color: var(--gfm-green);
            border: 2px solid var(--gfm-green);
        }

        .btn-secondary:hover {
            background: var(--gfm-green-light);
        }

        .btn-danger {
            background: var(--error);
            color: white;
            margin-top: 15px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* ========== IMAGE INPUTS ========== */
        .image-section {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 16px;
            border: 2px dashed rgba(0, 185, 100, 0.3);
        }

        .image-thumbs {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
            justify-content: center;
        }

        .thumb {
            width: 52px;
            height: 52px;
            border-radius: 10px;
            background: var(--bg-grey);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-light);
            overflow: hidden;
            border: 2px solid var(--border-light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .thumb.filled {
            border-color: var(--gfm-green);
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-url-inputs {
            display: none;
        }

        .image-url-inputs.show {
            display: block;
        }

        .image-url-inputs input {
            margin-bottom: 10px;
            font-size: 0.85em;
        }

        .toggle-urls-btn {
            width: 100%;
            padding: 10px;
            background: transparent;
            border: none;
            color: var(--gfm-green);
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            text-decoration: underline;
        }

        /* ========== LOADING ========== */
        .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-light);
            border-top-color: var(--gfm-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* ========== MESSAGES ========== */
        .message {
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 18px;
            font-size: 0.9em;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        .message.success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
        }

        /* ========== PREVIEW ========== */
        .preview-title {
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
            color: var(--gfm-green);
            margin-bottom: 18px;
        }

        .preview-placeholder {
            background: linear-gradient(135deg, var(--gfm-green) 0%, var(--gfm-green-dark) 100%);
            border-radius: 16px;
            padding: 50px 25px;
            text-align: center;
            color: white;
        }

        .preview-placeholder h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        #livePreview {
            display: none;
        }

        #livePreview.show {
            display: block;
        }

        /* ========== CODE OUTPUT ========== */
        .code-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid var(--border-light);
            display: none;
        }

        .code-section.show {
            display: block;
        }

        .code-output {
            background: #1a202c;
            color: #68d391;
            padding: 16px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.75em;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 15px;
        }

        /* ========== TOGGLE ========== */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: var(--bg-white);
            border-radius: 10px;
            margin-bottom: 14px;
        }

        .toggle-label {
            font-weight: 500;
            font-size: 0.9em;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--gfm-green);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* ========== RANGE ========== */
        .range-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
        }

        .range-row input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: var(--border-light);
            border-radius: 3px;
            outline: none;
            margin: 0;
            padding: 0;
        }

        .range-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--gfm-green);
            border-radius: 50%;
            cursor: pointer;
        }

        .range-value {
            min-width: 55px;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--gfm-green);
            text-align: right;
        }

        /* ========== SAVED STATUS ========== */
        .saved-status {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            color: #047857;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.82em;
            font-weight: 500;
            text-align: center;
            margin-bottom: 18px;
            display: none;
        }

        .saved-status.show {
            display: block;
        }

        /* ========== FUNDING STATS ========== */
        .funding-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .funding-grid input {
            margin-bottom: 0;
            font-size: 0.9em;
        }

        /* ========== FOOTER ========== */
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-light);
            font-size: 0.9em;
            grid-column: 1 / -1;
        }

        .footer a {
            color: var(--gfm-green);
            text-decoration: none;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Organizing your story...</div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>üíö iTabs for GoFundMe</h1>
            <p>Turn your story into something people actually read</p>
            <span class="badge">AI-Powered ‚Ä¢ Free</span>
        </header>

        <!-- Form Panel -->
        <main class="form-panel">
            <div class="saved-status" id="savedStatus">üíæ Your work is automatically saved!</div>

            <!-- Why Section -->
            <div class="why-section">
                <h3>ü§î Why use iTabs for GoFundMe?</h3>
                <p>
                    <strong>The problem:</strong> Most GoFundMe pages are walls of text. People scroll past without reading. Only 27% of campaigns reach their goal.<br><br>
                    <strong>The solution:</strong> iTabs shows photos first (people stop to look), then the "i" button reveals your story organized into clear sections. People CHOOSE to learn more ‚Äî which means they're already engaged.<br><br>
                    <strong>The result:</strong> More people understand your story ‚Üí More trust ‚Üí More donations.
                </p>
            </div>

            <!-- Templates -->
            <div class="form-section">
                <div class="section-title">üé® Try an Example</div>
                <div class="template-buttons">
                    <button class="template-btn" onclick="loadTemplate('medical')">üè• Medical</button>
                    <button class="template-btn" onclick="loadTemplate('memorial')">üïØÔ∏è Memorial</button>
                    <button class="template-btn" onclick="loadTemplate('emergency')">üö® Emergency</button>
                    <button class="template-btn active" onclick="loadTemplate('blank')">‚úèÔ∏è Start Blank</button>
                </div>
                <p class="helper-text">See how different campaigns look, or start fresh</p>
            </div>

            <!-- AI Section -->
            <div class="form-section" style="background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%); border: 2px solid var(--gfm-green);">
                <div class="section-title">ü§ñ Let AI Organize Your Story</div>
                
                <div class="info-box">
                    <strong>One-time setup:</strong> Get a free Gemini API key. 
                    <a href="https://aistudio.google.com/app/apikey" target="_blank">Get your key here ‚Üí</a>
                </div>
                
                <label>Gemini API Key</label>
                <input type="text" id="geminiKey" placeholder="AIza..." oninput="saveToStorage()">
                
                <label>Paste your GoFundMe story</label>
                <textarea id="storyText" rows="6" placeholder="Copy your GoFundMe campaign text and paste it here...

Or just describe your situation:
- What happened?
- Who needs help?
- How much do you need and for what?
- Why should people trust this?" oninput="saveToStorage()"></textarea>
                
                <button class="btn btn-primary" onclick="generateWithAI()" id="aiBtn">
                    ‚ú® Organize with AI
                </button>
                
                <div class="message error" id="errorMsg"></div>
                <div class="message success" id="successMsg"></div>
            </div>

            <!-- Campaign Details -->
            <div class="form-section">
                <div class="section-title">üìã Campaign Details</div>
                
                <label>Campaign Name *</label>
                <input type="text" id="campaignName" placeholder="e.g., Help Sarah Fight Cancer" oninput="saveToStorage(); updatePreview()">
                
                <label>GoFundMe Link</label>
                <input type="url" id="gofundmeUrl" placeholder="https://gofundme.com/f/your-campaign" oninput="saveToStorage()">
                <p class="helper-text">Where the "Donate" button links to</p>
            </div>

            <!-- Images -->
            <div class="form-section">
                <div class="section-title">üì∏ Your Photos</div>
                
                <div class="image-section">
                    <div class="image-thumbs">
                        <div class="thumb" id="thumb1" onclick="toggleUrlInputs()"><span>1</span></div>
                        <div class="thumb" id="thumb2" onclick="toggleUrlInputs()"><span>2</span></div>
                        <div class="thumb" id="thumb3" onclick="toggleUrlInputs()"><span>3</span></div>
                        <div class="thumb" id="thumb4" onclick="toggleUrlInputs()"><span>4</span></div>
                        <div class="thumb" id="thumb5" onclick="toggleUrlInputs()"><span>5</span></div>
                    </div>
                    
                    <button class="toggle-urls-btn" onclick="toggleUrlInputs()">Click to add image URLs ‚ñº</button>
                    
                    <div class="image-url-inputs" id="urlInputs">
                        <input type="url" id="image1" placeholder="Image 1 URL..." oninput="updateThumb(1); saveToStorage(); updatePreview()">
                        <input type="url" id="image2" placeholder="Image 2 URL..." oninput="updateThumb(2); saveToStorage(); updatePreview()">
                        <input type="url" id="image3" placeholder="Image 3 URL..." oninput="updateThumb(3); saveToStorage(); updatePreview()">
                        <input type="url" id="image4" placeholder="Image 4 URL..." oninput="updateThumb(4); saveToStorage(); updatePreview()">
                        <input type="url" id="image5" placeholder="Image 5 URL..." oninput="updateThumb(5); saveToStorage(); updatePreview()">
                        <p class="helper-text" style="margin-top: 5px;">Tip: Right-click any image online ‚Üí "Copy image address"</p>
                    </div>
                </div>
            </div>

            <!-- The 4 Sections -->
            <div class="form-section">
                <div class="section-title">‚úèÔ∏è Your Story (4 Sections)</div>
                <p class="helper-text" style="margin-top: -10px; margin-bottom: 16px;">AI generates these ‚Äî edit as needed</p>
                
                <label>üö® The Crisis ‚Äî What happened?</label>
                <textarea id="section1" placeholder="What crisis or situation led to this campaign? Be specific..." oninput="saveToStorage(); updatePreview()"></textarea>
                
                <label>üíî Why We Need Help ‚Äî What's at stake?</label>
                <textarea id="section2" placeholder="What happens if you don't reach your goal? Why is time important?" oninput="saveToStorage(); updatePreview()"></textarea>
                
                <label>üí∞ Where Money Goes ‚Äî Be specific</label>
                <textarea id="section3" placeholder="Break down exactly what donations will cover..." oninput="saveToStorage(); updatePreview()"></textarea>
                
                <label>‚úÖ Why Trust This ‚Äî Verification</label>
                <textarea id="section4" placeholder="How can people verify this is real? Who are you? Updates?" oninput="saveToStorage(); updatePreview()"></textarea>
            </div>

            <!-- Funding Stats -->
            <div class="form-section">
                <div class="section-title">üìä Funding Progress (Optional)</div>
                <p class="helper-text" style="margin-top: -10px; margin-bottom: 14px;">Shows a progress bar ‚Äî leave blank to hide</p>
                
                <div class="funding-grid">
                    <div>
                        <label>Raised</label>
                        <input type="text" id="amountRaised" placeholder="$5,230" oninput="saveToStorage(); updatePreview()">
                    </div>
                    <div>
                        <label>Goal</label>
                        <input type="text" id="fundingGoal" placeholder="$15,000" oninput="saveToStorage(); updatePreview()">
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="form-section">
                <div class="section-title">‚öôÔ∏è Display Settings</div>
                
                <div class="toggle-row">
                    <span class="toggle-label">Auto-play slideshow</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoplayToggle" checked onchange="saveToStorage(); updatePreview()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <label>Slideshow Speed</label>
                <div class="range-row">
                    <input type="range" id="autoplaySpeed" min="2" max="8" value="4" oninput="updateSpeedDisplay(); saveToStorage()">
                    <span class="range-value" id="speedValue">4 sec</span>
                </div>
                
                <label>Overlay Text (shows on first image)</label>
                <input type="text" id="overlayText" placeholder="e.g., Please Help üôè" oninput="saveToStorage(); updatePreview()">
                
                <label>Donate Button Text</label>
                <input type="text" id="buttonText" value="Donate Now" oninput="saveToStorage(); updatePreview()">
            </div>

            <!-- Buttons -->
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="updatePreview()">üëÅÔ∏è Update Preview</button>
                <button class="btn btn-primary" onclick="generateCode()">üìã Generate Code</button>
            </div>

            <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear All</button>

            <!-- Code Output -->
            <div class="code-section" id="codeSection">
                <h3 style="color: var(--gfm-green); margin-bottom: 12px; font-size: 1.05em;">üìã Your Embed Code</h3>
                <div class="code-output" id="codeOutput"></div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="copyCode()">üìã Copy Code</button>
                    <button class="btn btn-secondary" onclick="downloadHTML()">‚¨áÔ∏è Download</button>
                </div>
            </div>
        </main>

        <!-- Preview Panel -->
        <aside class="preview-panel">
            <h2 class="preview-title">üëÅÔ∏è Live Preview</h2>
            
            <div id="previewPlaceholder" class="preview-placeholder">
                <h3>üé® Your iTabs appears here</h3>
                <p>Add images and content to see it!</p>
            </div>
            
            <div id="livePreview"></div>
        </aside>

        <!-- Footer -->
        <footer class="footer">
            <p>Made with ‚ù§Ô∏è by <a href="https://itabs.ai">iTabs.ai</a> ‚Äî Making stories impossible to ignore</p>
        </footer>
    </div>

    <script>
        // ============ TEMPLATES ============
        const templates = {
            medical: {
                name: "Help Sarah Fight Cancer",
                images: [
                    "https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=600",
                    "https://images.unsplash.com/photo-1576091160550-2173dba999ef?w=600",
                    "https://images.unsplash.com/photo-1631815588090-d4bfec5b1ccb?w=600"
                ],
                section1: "Sarah, 34, was diagnosed with Stage 3 breast cancer two months ago. She's a single mum with two kids under 10. The cancer has spread to her lymph nodes and she needs aggressive chemotherapy starting immediately.",
                section2: "Without treatment, Sarah has less than 18 months. Her kids would grow up without their mum. The treatment gives her an 80% survival rate, but she can't work during chemo and her savings are already gone.",
                section3: "$15,000 for 6 months of chemotherapy co-pays. $8,000 for medication not covered by insurance. $7,000 for living expenses while Sarah can't work.",
                section4: "I'm Sarah's sister, Emma. Hospital records confirm her diagnosis. I'll post weekly updates with receipts. Sarah's oncologist can verify her treatment plan.",
                buttonText: "Donate to Sarah's Fight",
                overlayText: "Please Help Sarah üíö"
            },
            memorial: {
                name: "Honouring Dad ‚Äî Funeral Costs",
                images: [
                    "https://images.unsplash.com/photo-1517457373958-b7bdd4587205?w=600",
                    "https://images.unsplash.com/photo-1491438590914-bc09fcaaf77a?w=600",
                    "https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=600"
                ],
                section1: "Our dad, Michael, 58, passed away suddenly from a heart attack last Tuesday. He was the heart of our family ‚Äî coached little league for 20 years, never missed a school event.",
                section2: "Dad didn't have life insurance. Mum is disabled and lives on a pension. We have 10 days to arrange his funeral but we're $12,000 short.",
                section3: "$6,500 for funeral home services. $2,800 for cemetery plot. $1,500 for flowers and reception. $1,200 for headstone.",
                section4: "We're the Torres family from Fremantle. Dad's obituary is in the West Australian. All three siblings are managing this fund.",
                buttonText: "Help Us Honour Dad",
                overlayText: "In Loving Memory üïØÔ∏è"
            },
            emergency: {
                name: "Rebuild After the Fire",
                images: [
                    "https://images.unsplash.com/photo-1542856204-00101eb6def4?w=600",
                    "https://images.unsplash.com/photo-1582213782179-e0d53f98f2ca?w=600",
                    "https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=600"
                ],
                section1: "Last week's bushfire destroyed our home of 25 years. We evacuated with just our pets and the clothes on our backs. Everything is gone.",
                section2: "Insurance will cover rebuilding, but not for 6-8 months. We have nowhere to live and nothing to start over with.",
                section3: "$4,000 for 3 months temporary housing. $2,000 for clothes and essentials. $1,500 for kids' school supplies. $2,500 emergency buffer.",
                section4: "We're the Patterson family ‚Äî locals here for 25 years. Local ABC news covered our street. Happy to provide ID to major donors.",
                buttonText: "Help Us Rebuild",
                overlayText: "We Lost Everything üè†"
            },
            blank: {
                name: "",
                images: ["", "", "", "", ""],
                section1: "",
                section2: "",
                section3: "",
                section4: "",
                buttonText: "Donate Now",
                overlayText: ""
            }
        };

        // ============ STORAGE ============
        const STORAGE_KEY = 'itabs_gofundme_v1';

        function saveToStorage() {
            const data = {
                geminiKey: document.getElementById('geminiKey').value,
                storyText: document.getElementById('storyText').value,
                campaignName: document.getElementById('campaignName').value,
                gofundmeUrl: document.getElementById('gofundmeUrl').value,
                images: [
                    document.getElementById('image1').value,
                    document.getElementById('image2').value,
                    document.getElementById('image3').value,
                    document.getElementById('image4').value,
                    document.getElementById('image5').value
                ],
                section1: document.getElementById('section1').value,
                section2: document.getElementById('section2').value,
                section3: document.getElementById('section3').value,
                section4: document.getElementById('section4').value,
                amountRaised: document.getElementById('amountRaised').value,
                fundingGoal: document.getElementById('fundingGoal').value,
                autoplay: document.getElementById('autoplayToggle').checked,
                autoplaySpeed: document.getElementById('autoplaySpeed').value,
                overlayText: document.getElementById('overlayText').value,
                buttonText: document.getElementById('buttonText').value
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            document.getElementById('savedStatus').classList.add('show');
        }

        function loadFromStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;
            
            try {
                const data = JSON.parse(saved);
                if (data.geminiKey) document.getElementById('geminiKey').value = data.geminiKey;
                if (data.storyText) document.getElementById('storyText').value = data.storyText;
                if (data.campaignName) document.getElementById('campaignName').value = data.campaignName;
                if (data.gofundmeUrl) document.getElementById('gofundmeUrl').value = data.gofundmeUrl;
                if (data.images) {
                    data.images.forEach((url, i) => {
                        document.getElementById('image' + (i+1)).value = url || '';
                        updateThumb(i+1);
                    });
                }
                if (data.section1) document.getElementById('section1').value = data.section1;
                if (data.section2) document.getElementById('section2').value = data.section2;
                if (data.section3) document.getElementById('section3').value = data.section3;
                if (data.section4) document.getElementById('section4').value = data.section4;
                if (data.amountRaised) document.getElementById('amountRaised').value = data.amountRaised;
                if (data.fundingGoal) document.getElementById('fundingGoal').value = data.fundingGoal;
                if (data.autoplay !== undefined) document.getElementById('autoplayToggle').checked = data.autoplay;
                if (data.autoplaySpeed) {
                    document.getElementById('autoplaySpeed').value = data.autoplaySpeed;
                    updateSpeedDisplay();
                }
                if (data.overlayText) document.getElementById('overlayText').value = data.overlayText;
                if (data.buttonText) document.getElementById('buttonText').value = data.buttonText;
                
                document.getElementById('savedStatus').classList.add('show');
                updatePreview();
            } catch (e) {
                console.error('Load error:', e);
            }
        }

        function clearAll() {
            if (confirm('Clear all your work?')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // ============ TEMPLATES ============
        function loadTemplate(name) {
            const t = templates[name];
            
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(name) || 
                    (name === 'blank' && btn.textContent.includes('Blank'))) {
                    btn.classList.add('active');
                }
            });
            
            document.getElementById('campaignName').value = t.name;
            t.images.forEach((url, i) => {
                document.getElementById('image' + (i+1)).value = url || '';
                updateThumb(i+1);
            });
            document.getElementById('section1').value = t.section1;
            document.getElementById('section2').value = t.section2;
            document.getElementById('section3').value = t.section3;
            document.getElementById('section4').value = t.section4;
            document.getElementById('buttonText').value = t.buttonText;
            document.getElementById('overlayText').value = t.overlayText || '';
            
            saveToStorage();
            updatePreview();
        }

        // ============ UI HELPERS ============
        function updateThumb(n) {
            const url = document.getElementById('image' + n).value.trim();
            const thumb = document.getElementById('thumb' + n);
            if (url) {
                thumb.innerHTML = '<img src="' + url + '" alt="' + n + '">';
                thumb.classList.add('filled');
            } else {
                thumb.innerHTML = '<span>' + n + '</span>';
                thumb.classList.remove('filled');
            }
        }

        function toggleUrlInputs() {
            document.getElementById('urlInputs').classList.toggle('show');
        }

        function updateSpeedDisplay() {
            document.getElementById('speedValue').textContent = document.getElementById('autoplaySpeed').value + ' sec';
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.innerHTML = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        function showSuccess(msg) {
            const el = document.getElementById('successMsg');
            el.innerHTML = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // ============ AI GENERATION ============
        async function generateWithAI() {
            const geminiKey = document.getElementById('geminiKey').value.trim();
            const storyText = document.getElementById('storyText').value.trim();
            
            console.log('Generate clicked');
            console.log('Key length:', geminiKey.length);
            console.log('Story length:', storyText.length);
            
            if (!geminiKey) {
                showError('Please enter your Gemini API key. <a href="https://aistudio.google.com/app/apikey" target="_blank">Get one free ‚Üí</a>');
                return;
            }
            if (!storyText) {
                showError('Please paste your GoFundMe story or describe your situation');
                return;
            }
            
            document.getElementById('aiBtn').disabled = true;
            showLoading('AI is organizing your story...');
            
            try {
                const prompt = `You are helping organize a GoFundMe campaign story into 4 clear sections.

Here is the campaign story (use ONLY facts from this - don't invent anything):
---
${storyText.substring(0, 5000)}
---

Reorganize into these 4 sections. Keep the person's voice and emotion. Be specific and compelling.

Return ONLY valid JSON:
{
    "section1": "THE CRISIS - What happened? (2-3 sentences, specific details)",
    "section2": "WHY WE NEED HELP - What's at stake? What happens without help? (2-3 sentences)",
    "section3": "WHERE MONEY GOES - Specific breakdown of costs (2-3 sentences with dollar amounts if mentioned)",
    "section4": "WHY TRUST THIS - Who is organizing? How can people verify? Updates? (2-3 sentences)"
}`;

                console.log('Calling Gemini API...');
                
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + geminiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.error) {
                    console.error('API Error:', data.error);
                    throw new Error(data.error.message || 'API error');
                }
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                    let text = data.candidates[0].content.parts[0].text;
                    console.log('AI response text:', text);
                    
                    // Remove markdown code blocks if present
                    text = text.replace(/```json\s*/gi, '').replace(/```\s*/gi, '');
                    
                    // Try to extract JSON
                    const match = text.match(/\{[\s\S]*\}/);
                    
                    if (match) {
                        let jsonStr = match[0];
                        
                        // Clean up common JSON issues from AI
                        // Fix unescaped quotes inside strings
                        // Replace smart quotes with regular quotes
                        jsonStr = jsonStr.replace(/[\u201C\u201D]/g, '"');
                        jsonStr = jsonStr.replace(/[\u2018\u2019]/g, "'");
                        
                        let content;
                        try {
                            content = JSON.parse(jsonStr);
                        } catch (parseError) {
                            console.error('JSON parse error:', parseError);
                            console.log('Problematic JSON:', jsonStr);
                            
                            // Try a more aggressive cleanup - extract values manually
                            const section1Match = text.match(/"section1"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/);
                            const section2Match = text.match(/"section2"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/);
                            const section3Match = text.match(/"section3"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/);
                            const section4Match = text.match(/"section4"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/);
                            
                            content = {
                                section1: section1Match ? section1Match[1] : '',
                                section2: section2Match ? section2Match[1] : '',
                                section3: section3Match ? section3Match[1] : '',
                                section4: section4Match ? section4Match[1] : ''
                            };
                            console.log('Extracted manually:', content);
                        }
                        
                        console.log('Parsed content:', content);
                        
                        // Try different possible key names
                        const s1 = content.section1 || content.crisis || content.theCrisis || content['The Crisis'] || '';
                        const s2 = content.section2 || content.whyWeNeedHelp || content.whyHelp || content['Why We Need Help'] || '';
                        const s3 = content.section3 || content.whereMoneyGoes || content.money || content['Where Money Goes'] || '';
                        const s4 = content.section4 || content.whyTrustThis || content.trust || content['Why Trust This'] || '';
                        
                        console.log('Section 1:', s1);
                        console.log('Section 2:', s2);
                        console.log('Section 3:', s3);
                        console.log('Section 4:', s4);
                        
                        document.getElementById('section1').value = s1;
                        document.getElementById('section2').value = s2;
                        document.getElementById('section3').value = s3;
                        document.getElementById('section4').value = s4;
                        
                        saveToStorage();
                        updatePreview();
                        
                        if (s1 || s2 || s3 || s4) {
                            showSuccess('‚ú® Story organized! Edit as needed.');
                        } else {
                            showError('AI returned empty sections. Check console (F12) for details.');
                        }
                    } else {
                        throw new Error('Could not find JSON in AI response');
                    }
                } else {
                    console.error('Unexpected response structure:', data);
                    throw new Error('Invalid AI response structure');
                }
            } catch (error) {
                console.error('Full error:', error);
                showError('AI Error: ' + error.message);
            } finally {
                document.getElementById('aiBtn').disabled = false;
                hideLoading();
            }
        }

        // ============ PREVIEW ============
        function updatePreview() {
            const name = document.getElementById('campaignName').value || 'Your Campaign';
            const url = document.getElementById('gofundmeUrl').value || '#';
            const images = [
                document.getElementById('image1').value,
                document.getElementById('image2').value,
                document.getElementById('image3').value,
                document.getElementById('image4').value,
                document.getElementById('image5').value
            ].filter(u => u.trim());
            
            const section1 = document.getElementById('section1').value;
            const section2 = document.getElementById('section2').value;
            const section3 = document.getElementById('section3').value;
            const section4 = document.getElementById('section4').value;
            const buttonText = document.getElementById('buttonText').value || 'Donate Now';
            const overlayText = document.getElementById('overlayText').value;
            const amountRaised = document.getElementById('amountRaised').value;
            const fundingGoal = document.getElementById('fundingGoal').value;
            
            if (images.length === 0) {
                document.getElementById('previewPlaceholder').style.display = 'block';
                document.getElementById('livePreview').classList.remove('show');
                return;
            }
            
            document.getElementById('previewPlaceholder').style.display = 'none';
            document.getElementById('livePreview').classList.add('show');
            
            // Slides
            let slidesHTML = '';
            let dotsHTML = '';
            images.forEach((img, i) => {
                slidesHTML += '<div style="min-width:100%;height:100%;position:relative;">' +
                    '<img src="' + img + '" style="width:100%;height:100%;object-fit:cover;">' +
                    (i === 0 && overlayText ? '<div style="position:absolute;bottom:55px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:white;padding:8px 18px;border-radius:20px;font-size:14px;font-weight:500;white-space:nowrap;">' + overlayText + '</div>' : '') +
                    '</div>';
                dotsHTML += '<div class="prev-dot" data-i="' + i + '" style="width:9px;height:9px;border-radius:50%;background:' + (i===0?'white':'rgba(255,255,255,0.5)') + ';cursor:pointer;border:2px solid white;"></div>';
            });
            
            // Funding
            let fundingHTML = '';
            if (amountRaised && fundingGoal) {
                const raised = parseFloat(amountRaised.replace(/[^0-9.]/g, '')) || 0;
                const goal = parseFloat(fundingGoal.replace(/[^0-9.]/g, '')) || 1;
                const pct = Math.min(Math.round((raised / goal) * 100), 100);
                fundingHTML = '<div style="background:#f7fafc;padding:16px;border-radius:10px;margin-bottom:18px;">' +
                    '<div style="display:flex;justify-content:space-between;margin-bottom:8px;">' +
                    '<div><div style="font-size:1.4em;font-weight:bold;color:#00b964;">' + amountRaised + '</div><div style="font-size:0.8em;color:#718096;">of ' + fundingGoal + '</div></div>' +
                    '</div>' +
                    '<div style="background:#e2e8f0;height:6px;border-radius:3px;overflow:hidden;">' +
                    '<div style="background:linear-gradient(135deg,#00b964,#00a857);height:100%;width:' + pct + '%;"></div>' +
                    '</div></div>';
            }
            
            // Popup content
            let popupContent = fundingHTML;
            if (section1) popupContent += '<div style="margin-bottom:16px;"><h4 style="color:#00b964;font-size:1em;margin-bottom:6px;">üö® The Crisis</h4><p style="color:#4a5568;line-height:1.6;font-size:0.95em;">' + section1 + '</p></div>';
            if (section2) popupContent += '<div style="margin-bottom:16px;"><h4 style="color:#00b964;font-size:1em;margin-bottom:6px;">üíî Why We Need Help</h4><p style="color:#4a5568;line-height:1.6;font-size:0.95em;">' + section2 + '</p></div>';
            if (section3) popupContent += '<div style="margin-bottom:16px;"><h4 style="color:#00b964;font-size:1em;margin-bottom:6px;">üí∞ Where Money Goes</h4><p style="color:#4a5568;line-height:1.6;font-size:0.95em;">' + section3 + '</p></div>';
            if (section4) popupContent += '<div style="margin-bottom:16px;"><h4 style="color:#00b964;font-size:1em;margin-bottom:6px;">‚úÖ Why Trust This</h4><p style="color:#4a5568;line-height:1.6;font-size:0.95em;">' + section4 + '</p></div>';
            
            const html = '<div style="background:white;border-radius:16px;overflow:hidden;box-shadow:0 6px 25px rgba(0,0,0,0.1);">' +
                '<div style="position:relative;width:100%;height:260px;overflow:hidden;background:linear-gradient(135deg,#00b964,#00a857);">' +
                '<div id="prevTrack" style="display:flex;height:100%;transition:transform 0.4s ease;">' + slidesHTML + '</div>' +
                '<div style="position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:7px;z-index:15;">' + dotsHTML + '</div>' +
                '<div id="prevCounter" style="position:absolute;bottom:12px;right:12px;background:rgba(0,0,0,0.5);color:white;padding:3px 9px;border-radius:10px;font-size:11px;font-weight:600;">1/' + images.length + '</div>' +
                '<div onclick="document.getElementById(\'prevPopup\').style.display=\'flex\'" style="position:absolute;top:12px;right:12px;width:40px;height:40px;background:rgba(255,255,255,0.95);color:#00b964;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:20px;cursor:pointer;box-shadow:0 3px 12px rgba(0,0,0,0.2);border:3px solid white;z-index:20;">i</div>' +
                '</div>' +
                '<div style="padding:18px;text-align:center;">' +
                '<h3 style="font-size:1.1em;color:#1a1a2e;margin-bottom:5px;">' + name + '</h3>' +
                '<p style="color:#718096;font-size:0.85em;">Swipe photos ‚Ä¢ Tap i for full story</p>' +
                '</div></div>' +
                '<div id="prevPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:1000;align-items:center;justify-content:center;padding:12px;">' +
                '<div style="background:white;border-radius:16px;max-width:400px;width:100%;max-height:80vh;overflow:hidden;">' +
                '<div style="background:linear-gradient(135deg,#00b964,#00a857);color:white;padding:20px;position:relative;">' +
                '<h3 style="font-size:1.15em;margin-bottom:3px;">' + name + '</h3>' +
                '<p style="opacity:0.9;font-size:0.85em;">The Full Story</p>' +
                '<button onclick="document.getElementById(\'prevPopup\').style.display=\'none\'" style="position:absolute;top:10px;right:10px;width:28px;height:28px;background:rgba(255,255,255,0.2);border:none;border-radius:50%;color:white;font-size:16px;cursor:pointer;">√ó</button>' +
                '</div>' +
                '<div style="padding:20px;max-height:calc(80vh - 90px);overflow-y:auto;">' + popupContent +
                '<a href="' + url + '" target="_blank" style="display:block;width:100%;padding:14px;background:linear-gradient(135deg,#00b964,#00a857);color:white;text-align:center;text-decoration:none;border-radius:10px;font-weight:600;margin-top:18px;box-sizing:border-box;">' + buttonText + '</a>' +
                '</div></div></div>';
            
            document.getElementById('livePreview').innerHTML = html;
            setupPreview(images.length);
        }

        function setupPreview(total) {
            let current = 0;
            const autoplay = document.getElementById('autoplayToggle').checked;
            const speed = document.getElementById('autoplaySpeed').value;
            
            const update = () => {
                const track = document.getElementById('prevTrack');
                const counter = document.getElementById('prevCounter');
                const dots = document.querySelectorAll('.prev-dot');
                if (track) track.style.transform = 'translateX(-' + (current * 100) + '%)';
                if (counter) counter.textContent = (current + 1) + '/' + total;
                dots.forEach((d, i) => d.style.background = i === current ? 'white' : 'rgba(255,255,255,0.5)');
            };
            
            document.querySelectorAll('.prev-dot').forEach(dot => {
                dot.onclick = () => { current = parseInt(dot.dataset.i); update(); };
            });
            
            const track = document.getElementById('prevTrack');
            let startX = 0;
            if (track) {
                track.ontouchstart = e => startX = e.changedTouches[0].screenX;
                track.ontouchend = e => {
                    const diff = startX - e.changedTouches[0].screenX;
                    if (Math.abs(diff) > 50) {
                        current = diff > 0 ? (current + 1) % total : (current - 1 + total) % total;
                        update();
                    }
                };
            }
            
            const popup = document.getElementById('prevPopup');
            if (popup) popup.onclick = e => { if (e.target.id === 'prevPopup') popup.style.display = 'none'; };
            
            if (autoplay && total > 1) {
                setInterval(() => { current = (current + 1) % total; update(); }, speed * 1000);
            }
        }

        // ============ CODE GENERATION ============
        function generateCode() {
            const name = document.getElementById('campaignName').value || 'Campaign';
            const url = document.getElementById('gofundmeUrl').value || '#';
            const images = [
                document.getElementById('image1').value,
                document.getElementById('image2').value,
                document.getElementById('image3').value,
                document.getElementById('image4').value,
                document.getElementById('image5').value
            ].filter(u => u.trim());
            
            if (images.length === 0) {
                showError('Please add at least one image');
                return;
            }
            
            const section1 = document.getElementById('section1').value;
            const section2 = document.getElementById('section2').value;
            const section3 = document.getElementById('section3').value;
            const section4 = document.getElementById('section4').value;
            const buttonText = document.getElementById('buttonText').value || 'Donate Now';
            const overlayText = document.getElementById('overlayText').value;
            const autoplay = document.getElementById('autoplayToggle').checked;
            const speed = document.getElementById('autoplaySpeed').value;
            const amountRaised = document.getElementById('amountRaised').value;
            const fundingGoal = document.getElementById('fundingGoal').value;
            
            let slidesCode = '';
            let dotsCode = '';
            images.forEach((img, i) => {
                slidesCode += '            <div style="min-width:100%;height:100%;position:relative;">\n' +
                    '                <img src="' + img + '" alt="' + name + ' ' + (i+1) + '" style="width:100%;height:100%;object-fit:cover;">\n' +
                    (i === 0 && overlayText ? '                <div style="position:absolute;bottom:55px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:white;padding:8px 18px;border-radius:20px;font-size:14px;font-weight:500;white-space:nowrap;">' + overlayText + '</div>\n' : '') +
                    '            </div>\n';
                dotsCode += '            <div class="itabs-dot" style="width:10px;height:10px;border-radius:50%;background:' + (i===0?'white':'rgba(255,255,255,0.5)') + ';cursor:pointer;border:2px solid white;"></div>\n';
            });
            
            let fundingCode = '';
            if (amountRaised && fundingGoal) {
                const raised = parseFloat(amountRaised.replace(/[^0-9.]/g, '')) || 0;
                const goal = parseFloat(fundingGoal.replace(/[^0-9.]/g, '')) || 1;
                const pct = Math.min(Math.round((raised / goal) * 100), 100);
                fundingCode = '            <div style="background:#f7fafc;padding:16px;border-radius:10px;margin-bottom:18px;">\n' +
                    '                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">\n' +
                    '                    <div><div style="font-size:1.4em;font-weight:bold;color:#00b964;">' + amountRaised + '</div><div style="font-size:0.8em;color:#718096;">of ' + fundingGoal + '</div></div>\n' +
                    '                </div>\n' +
                    '                <div style="background:#e2e8f0;height:6px;border-radius:3px;overflow:hidden;">\n' +
                    '                    <div style="background:linear-gradient(135deg,#00b964,#00a857);height:100%;width:' + pct + '%;"></div>\n' +
                    '                </div>\n' +
                    '            </div>\n';
            }
            
            let popupCode = fundingCode;
            if (section1) popupCode += '            <div style="margin-bottom:16px;"><h4 style="color:#00b964;font-size:1em;margin-bottom:6px;">üö® The Crisis</h4><p style="color:#4a5568;line-height:1.6;font-size:0.95em;">' + section1 + '</p></div>\n';
            if (section2) popupCode += '            <div style="margin-bottom:16px;"><h4 style="color:#00b964;font-size:1em;margin-bottom:6px;">üíî Why We Need Help</h4><p style="color:#4a5568;line-height:1.6;font-size:0.95em;">' + section2 + '</p></div>\n';
            if (section3) popupCode += '            <div style="margin-bottom:16px;"><h4 style="color:#00b964;font-size:1em;margin-bottom:6px;">üí∞ Where Money Goes</h4><p style="color:#4a5568;line-height:1.6;font-size:0.95em;">' + section3 + '</p></div>\n';
            if (section4) popupCode += '            <div style="margin-bottom:16px;"><h4 style="color:#00b964;font-size:1em;margin-bottom:6px;">‚úÖ Why Trust This</h4><p style="color:#4a5568;line-height:1.6;font-size:0.95em;">' + section4 + '</p></div>\n';
            
            const code = '<!-- iTabs for GoFundMe - Generated by itabs.ai -->\n' +
'<div style="background:white;border-radius:20px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.1);max-width:480px;margin:20px auto;font-family:-apple-system,BlinkMacSystemFont,Poppins,sans-serif;">\n' +
'    <div style="position:relative;width:100%;height:320px;overflow:hidden;background:linear-gradient(135deg,#00b964,#00a857);">\n' +
'        <div id="itabsTrack" style="display:flex;height:100%;transition:transform 0.4s ease;">\n' +
slidesCode +
'        </div>\n' +
'        <div style="position:absolute;bottom:14px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:15;">\n' +
dotsCode +
'        </div>\n' +
'        <div id="itabsCounter" style="position:absolute;bottom:14px;right:14px;background:rgba(0,0,0,0.5);color:white;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;">1/' + images.length + '</div>\n' +
'        <div onclick="document.getElementById(\'itabsPopup\').style.display=\'flex\'" style="position:absolute;top:14px;right:14px;width:44px;height:44px;background:rgba(255,255,255,0.95);color:#00b964;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:22px;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,0.2);border:3px solid white;z-index:20;">i</div>\n' +
'    </div>\n' +
'    <div style="padding:20px;text-align:center;">\n' +
'        <h3 style="font-size:1.2em;color:#1a1a2e;margin:0 0 6px 0;">' + name + '</h3>\n' +
'        <p style="color:#718096;font-size:0.9em;margin:0;">Swipe photos ‚Ä¢ Tap i for full story</p>\n' +
'    </div>\n' +
'</div>\n\n' +
'<div id="itabsPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;padding:15px;">\n' +
'    <div style="background:white;border-radius:20px;max-width:450px;width:90%;max-height:85vh;overflow:hidden;">\n' +
'        <div style="background:linear-gradient(135deg,#00b964,#00a857);color:white;padding:24px;position:relative;">\n' +
'            <h3 style="font-size:1.3em;margin:0 0 4px 0;">' + name + '</h3>\n' +
'            <p style="opacity:0.9;font-size:0.9em;margin:0;">The Full Story</p>\n' +
'            <button onclick="document.getElementById(\'itabsPopup\').style.display=\'none\'" style="position:absolute;top:12px;right:12px;width:32px;height:32px;background:rgba(255,255,255,0.2);border:none;border-radius:50%;color:white;font-size:20px;cursor:pointer;">√ó</button>\n' +
'        </div>\n' +
'        <div style="padding:24px;max-height:calc(85vh - 100px);overflow-y:auto;">\n' +
popupCode +
'            <a href="' + url + '" target="_blank" style="display:block;width:100%;padding:16px;background:linear-gradient(135deg,#00b964,#00a857);color:white;text-align:center;text-decoration:none;border-radius:12px;font-weight:600;font-size:1.05em;margin-top:20px;box-sizing:border-box;">' + buttonText + '</a>\n' +
'        </div>\n' +
'    </div>\n' +
'</div>\n\n' +
'<div onclick="document.getElementById(\'itabsInfoPopup\').style.display=\'flex\'" style="position:fixed;bottom:18px;right:18px;width:38px;height:38px;background:white;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 3px 12px rgba(0,0,0,0.15);border:2px solid #00b964;cursor:pointer;z-index:999;">\n' +
'    <div style="color:#00b964;font-size:14px;font-weight:bold;line-height:1;">i</div>\n' +
'    <div style="color:#00b964;font-size:6px;font-weight:600;text-transform:uppercase;">iTabs</div>\n' +
'</div>\n\n' +
'<div id="itabsInfoPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1001;align-items:center;justify-content:center;padding:15px;">\n' +
'    <div style="background:white;border-radius:20px;max-width:380px;width:90%;overflow:hidden;">\n' +
'        <div style="background:linear-gradient(135deg,#00b964,#00a857);color:white;padding:20px;position:relative;">\n' +
'            <h3 style="font-size:1.2em;margin:0;">üíö Made with iTabs</h3>\n' +
'            <button onclick="document.getElementById(\'itabsInfoPopup\').style.display=\'none\'" style="position:absolute;top:10px;right:10px;width:28px;height:28px;background:rgba(255,255,255,0.2);border:none;border-radius:50%;color:white;font-size:16px;cursor:pointer;">√ó</button>\n' +
'        </div>\n' +
'        <div style="padding:22px;">\n' +
'            <p style="color:#4a5568;line-height:1.7;margin:0 0 18px 0;">This visual story was created with iTabs - making fundraising campaigns impossible to ignore.</p>\n' +
'            <a href="https://itabs.ai/gofundme" target="_blank" style="display:block;width:100%;padding:14px;background:linear-gradient(135deg,#00b964,#00a857);color:white;text-align:center;text-decoration:none;border-radius:10px;font-weight:600;box-sizing:border-box;">Create Your Own iTabs ‚Üí</a>\n' +
'        </div>\n' +
'    </div>\n' +
'</div>\n\n' +
'<script>\n' +
'(function(){\n' +
'    var c=0,t=' + images.length + ';\n' +
'    function u(){\n' +
'        var tr=document.getElementById("itabsTrack"),ct=document.getElementById("itabsCounter"),ds=document.querySelectorAll(".itabs-dot");\n' +
'        if(tr)tr.style.transform="translateX(-"+(c*100)+"%)";\n' +
'        if(ct)ct.textContent=(c+1)+"/"+t;\n' +
'        ds.forEach(function(d,i){d.style.background=i===c?"white":"rgba(255,255,255,0.5)";});\n' +
'    }\n' +
'    var tr=document.getElementById("itabsTrack"),sx=0;\n' +
'    if(tr){\n' +
'        tr.addEventListener("touchstart",function(e){sx=e.changedTouches[0].screenX;});\n' +
'        tr.addEventListener("touchend",function(e){\n' +
'            var d=sx-e.changedTouches[0].screenX;\n' +
'            if(Math.abs(d)>50){c=d>0?(c+1)%t:(c-1+t)%t;u();}\n' +
'        });\n' +
'    }\n' +
'    document.querySelectorAll(".itabs-dot").forEach(function(d,i){d.addEventListener("click",function(){c=i;u();});});\n' +
'    ["itabsPopup","itabsInfoPopup"].forEach(function(id){\n' +
'        var el=document.getElementById(id);\n' +
'        if(el)el.addEventListener("click",function(e){if(e.target.id===id)el.style.display="none";});\n' +
'    });\n' +
(autoplay && images.length > 1 ? '    setInterval(function(){c=(c+1)%t;u();},' + (speed * 1000) + ');\n' : '') +
'})();\n' +
'<\/script>';

            document.getElementById('codeOutput').textContent = code;
            document.getElementById('codeSection').classList.add('show');
            document.getElementById('codeSection').scrollIntoView({ behavior: 'smooth' });
            showSuccess('‚úÖ Code generated!');
        }

        function copyCode() {
            const code = document.getElementById('codeOutput').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showSuccess('‚úÖ Copied to clipboard!');
            }).catch(() => {
                const ta = document.createElement('textarea');
                ta.value = code;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.select();
                try {
                    document.execCommand('copy');
                    showSuccess('‚úÖ Copied!');
                } catch (e) {
                    showError('Copy failed');
                }
                document.body.removeChild(ta);
            });
        }

        function downloadHTML() {
            const code = document.getElementById('codeOutput').textContent;
            const name = document.getElementById('campaignName').value || 'campaign';
            const html = '<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width,initial-scale=1.0">\n<title>' + name + ' - iTabs</title>\n</head>\n<body style="margin:0;padding:20px;background:#f5f5f5;min-height:100vh;">\n' + code + '\n</body>\n</html>';
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name.toLowerCase().replace(/\s+/g, '-') + '-itabs.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showSuccess('‚úÖ Downloaded!');
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            updateSpeedDisplay();
        });
    </script>
</body>
</html>
